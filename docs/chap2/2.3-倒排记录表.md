# 倒排记录表

## 基于跳表的倒排记录表合并

还记得我们在2.1节讲到的两个链表合并吗？我们说理想情况下，这个方法的时间复杂度是$O(m+n)$，那还有没有更优化的方法？答案是有的。这就是今天我们要讲的跳表。

![1735577897431](C:\Users\马世拓\AppData\Roaming\Typora\typora-user-images\1735577897431.png)

如图，我们如果放置这样的跳表，假定匹配到上下的指针都指向8，接下来两个指针都向下移动一位。比较41和11，11小。此时看11上面的跳表指针，指向31，31仍然比41小，于是下指针可以直接跳过中间的11、17、21、31。

![1735577941614](C:\Users\马世拓\AppData\Roaming\Typora\typora-user-images\1735577941614.png)

指针数目过多过少都不合适，要有一个均衡性:

- 指针越多，跳步越短，更容易跳转，但是需要更多的与跳表指针指向记录的比较
- 指针越少，比较次数越少，但是跳步越长，成功跳转的次数少

跳表指针的位置有一些讲究：

- 简单的启发式策略：对于长度为L的倒排记录表，每√L处放一个跳表指针，即均匀放置。均匀放置方法忽略了查询词项的分布情况
- 如果索引相对静态，均匀放置方法是一种很简便的方法，但是如果索引经常更新造成L经常变化，均匀方式就很不方便
- 跳表方式在过去肯定是有用的，但是对于现代的硬件设备而言，如果合并的倒排记录表不能全部放入内存的话，上述方式不一定有用（Bahle et al. 2002）

## 含位置的倒排记录表与短语查询

短语查询是说输入查询作为一个短语整体，比如 “stanford university”  “中国科学院”，因此，句子 “I went to university at Stanford” 就不应该是答案 （“我去了中国农业科学院”）。有证据表明，用户很容易理解短语查询的概念，这也是很多搜索引擎”高级搜索”中比较成功的一个功能。但是很多查询是隐式短语查询， 这种情况下，倒排记录表中仅保存docID是不够的。

第一种方法是双词索引。每两个连续的词组成词对(作为短语)来索引，比如文本片段 “Friends, Romans, Countrymen” 会产生两个词对。索引构建时，将每个词对看成一个词项放到词典中。这样的话，两个词组成的短语查询就能直接处理。但如果查询很长，这样的方法有道理吗？随便两个连续的词就能组成短语了？似乎不太能。于是，我们考虑做短语分析，这一部分我们也在自然语言处理教程的第三章当中讨论过，这里简单聊聊思想。因为短语的组成也有一定的句法搭配，那么我们就可以先对查询做一趟词性标注，把遵循一定词性规则的组合到一起（比如名词+冠词结构）。但这可能出现伪正例，并且如果是三个word组成的短语那空间直接裂开。双词索引方法并不是一个标准的做法 (即倒排索引中一般不会全部采用双词索引方法)，但是可以和其他方法混合使用。

第二种方法是位置索引。在倒排记录表中，对每个词项在每篇文档中的每个位置(偏移或者单词序号)进行存储。每个词项的倒排记录中的每一项，除了包括docID外，还包括一个位置列表。不仅仅简单按docID进行合并，还要考虑位置匹配。首先，找出同时包含这些词项的文档；对每个词项，抽出其对应的倒排记录；检查这些文档的位置列表，看各个词项之间是否存在与查询请求相同的位置关系，例如，是否在某个be的前面一个词条位置上正好出现了to。位置索引还可用于邻近搜索中，其搜索策略与短语查询类似，不同的是此时应考虑前后位置之间的距离不大于某个值。

![1735578511076](C:\Users\马世拓\AppData\Roaming\Typora\typora-user-images\1735578511076.png)

- 位置索引增加了位置信息，因此空间较大，但是可以采用索引压缩技术进行处理(参见第五讲)
- 当然，相对于没有位置信息的索引，位置索引的存储空间明显大于无位置信息的索引
- 另外，位置索引目前是实际检索系统的标配，这是因为实际中需要处理短语(显式和隐式)和邻近式查询







